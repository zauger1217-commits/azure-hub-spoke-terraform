## Azure Hub-and-Spoke Terraform Lab â˜ï¸ğŸ§±

This repository provisions a modular **Hub-and-Spoke network architecture** in Microsoft Azure using **Terraform**.
The focus of this lab is on Infrastructure as Code (IaC), clean module design, and real-world troubleshooting
around Azure networking, VM deployment, and NSG access paths.

> Note: Some VM access and validation during early iterations was done using **ClickOps and RDP**
> (this lab originally started Windows-first). The infrastructure foundation and final access patterns
> are fully managed through Terraform.

---

## ğŸ—ï¸ Architecture Overview

**Core components:**
- Hub virtual network with workload and private endpoint subnets
- Two spoke virtual networks with workload subnets
- Hub â†” Spoke VNet peering
- Centralized Network Security Group (NSG)
- Linux virtual machines (hub + spokes)
- Storage account with Private Endpoint (hub)

The hub VM acts as a **jump point** for private access into spoke VMs.

---

## ğŸ“ Repository Structure

```
azure-hub-spoke-terraform/
â”œâ”€ main.tf
â”œâ”€ variables.tf
â”œâ”€ outputs.tf
â”œâ”€ locals.tf
â”œâ”€ providers.tf
â”œâ”€ versions.tf
â”œâ”€ terraform.tfvars.example
â”œâ”€ modules/
â”‚  â”œâ”€ rg/
â”‚  â”œâ”€ network-hub/
â”‚  â”œâ”€ network-spoke/
â”‚  â”œâ”€ nsg/
â”‚  â”œâ”€ nsg-subnet-assoc/
â”‚  â”œâ”€ nsg-nic-assoc/
â”‚  â”œâ”€ vm-linux/
â”‚  â”œâ”€ peering/
â”‚  â””â”€ private-endpoint-storage/
â””â”€ docs/
   â”œâ”€ architecture.md
   â””â”€ troubleshooting.md
```

---

## ğŸš€ Deployment Steps

### Prerequisites
- Azure subscription
- Azure CLI authenticated (`az login`)
- Terraform installed

### Deploy

```bash
cp terraform.tfvars.example terraform.tfvars
terraform init
terraform fmt -recursive
terraform validate
terraform apply
```

### Destroy

```bash
terraform destroy
```

---

## ğŸ” Configuration Notes

- SSH access is restricted using NSG rules:
  - Public SSH allowed only from `my_public_ip_cidr` (lab convenience)
  - Hub subnet â†’ Spoke subnet SSH allowed dynamically (no hardcoded CIDRs)
- Spoke VMs are deployed **without public IPs**
- VM size is configurable (lab default: `Standard_D2s_v3`)

---

## ğŸ§  Key Lessons Learned

- Azure VM SKUs can fail due to **regional capacity** even when valid
- Subscription **quota limits** can block entire VM families
- NSG rules must allow the *correct source* (local IP vs hub subnet vs spoke ranges)
- Terraform modules should dynamically discover subnet CIDRs instead of hardcoding values
- Separating network, security, and compute into modules improves maintainability

---

## ğŸ› ï¸ Future Improvements

- Replace public SSH with Azure Bastion
- Add Log Analytics and NSG flow logs
- Introduce CI validation with GitHub Actions
- Harden jumpbox access and remove public exposure

---

## ğŸ“Œ Purpose

This lab was built to reinforce **Azure networking fundamentals** and **Terraform module design**
while reflecting the kinds of troubleshooting scenarios encountered in real cloud operations roles.
