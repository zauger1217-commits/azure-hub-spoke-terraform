## â˜ï¸ Azure Hub-and-Spoke Networking Lab (NSGs, Peering, Break/Fix, Private Endpoint) ğŸš¦ğŸ”’

## ğŸŸ¦ Overview

This lab walks through a **cloud-engineer-style** build of a secure Azure network using a **hub-and-spoke** topology. You will:

- Build VNets + subnets
- Apply NSGs at **subnet + NIC** layers
- Configure inbound/outbound rules
- Perform **break/fix** troubleshooting
- Configure **VNet peering** and validate **non-transitive** behavior
- Configure a **Private Endpoint + Private DNS**, and validate private resolution
- Deploy the environment using **Terraform** (IaC)

**Terraform repo:** `<ADD YOUR LINK HERE>`

---

## ğŸ§± Architecture

### High-level topology (Hub-and-Spoke)

> ğŸ“Œ Add your architecture diagram image here (PNG/SVG recommended).
>
> Example:
> `![Hub-and-Spoke Architecture](docs/architecture.png)`

---

## ğŸ§© What Terraform Deploys

### ğŸŒ Networking
- **Hub VNet:** `vnet-hub`
  - Workload subnet: `snet-workload`
  - Private Endpoint subnet
- **Spoke VNets:** `vnet-spoke-a`, `vnet-spoke-b`
  - Workload subnets
- **VNet peerings:** Hub â†” Spokes

### ğŸ›¡ï¸ Security
- Central **NSG** applied to:
  - Subnets (hub + spokes)
  - NICs (lab choice)
- Key rules:
  - Allow SSH from **my public IP** (lab convenience)
  - Allow SSH from **hub subnet â†’ spokes** (dynamic subnet lookup; no hardcoded CIDRs)

### ğŸ–¥ï¸ Compute
- Linux VM in hub (optional public IP for lab access)
- Linux VMs in spokes (private only)

### ğŸ” Private Connectivity
- Storage account + **Private Endpoint** (hub)
- Private DNS integration (module-based)

---

## âœ… Prerequisites

- Azure subscription
- Azure CLI installed + logged in: `az login`
- Terraform installed

---

## ğŸš€ Deploy with Terraform

1) Copy the example tfvars:
```bash
cp terraform.tfvars.example terraform.tfvars
```

2) Initialize + deploy:
```bash
terraform init
terraform fmt -recursive
terraform validate
terraform apply
```

3) Tear down:
```bash
terraform destroy
```

---

## ğŸ”§ Break/Fix Scenarios

### âœ… Scenario 1 â€” VM Size / Region Capacity
**Symptom:** VM deployment fails with `SkuNotAvailable`  
**Fix:** Switch to a working VM size for the region (example: `Standard_D2s_v3`) and re-apply.

### âœ… Scenario 2 â€” Quota Limits (VM Family)
**Symptom:** VM deployment fails with quota errors (family core limit = 0)  
**Fix:** Use another VM family/size or request quota increase for that family.

### âœ… Scenario 3 â€” NSG Source Prefix Mistake
**Symptom:** SSH times out from hub â†’ spokes  
**Fix:** Ensure NSG allows **hub subnet CIDR** as source for port 22 into spokes (avoid hardcoding via subnet data lookup).

---

## ğŸ“‚ Repo Structure

```
.
â”œâ”€â”€ main.tf
â”œâ”€â”€ variables.tf
â”œâ”€â”€ locals.tf
â”œâ”€â”€ providers.tf
â”œâ”€â”€ versions.tf
â”œâ”€â”€ outputs.tf
â”œâ”€â”€ terraform.tfvars.example
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ rg/
â”‚   â”œâ”€â”€ network-hub/
â”‚   â”œâ”€â”€ network-spoke/
â”‚   â”œâ”€â”€ nsg/
â”‚   â”œâ”€â”€ nsg-subnet-assoc/
â”‚   â”œâ”€â”€ nsg-nic-assoc/
â”‚   â”œâ”€â”€ vm-linux/
â”‚   â”œâ”€â”€ peering/
â”‚   â””â”€â”€ private-endpoint-storage/
â””â”€â”€ docs/
    â”œâ”€â”€ architecture.md
    â””â”€â”€ troubleshooting.md
```

---

## ğŸ§  Skills Demonstrated

- Azure hub-and-spoke design
- VNet peering + routing behavior (non-transitive)
- NSG design (subnet + NIC scope)
- Private Endpoints + Private DNS
- Terraform module composition + reusable patterns
- Real-world troubleshooting: SKU capacity, quota limits, and NSG scoping

---

## ğŸ› ï¸ Notes / Improvements

- Replace public SSH with **Azure Bastion**
- Add **NSG flow logs** + **Log Analytics**
- Add a GitHub Actions workflow for `terraform fmt/validate/plan`
- Harden jump access and remove public exposure

